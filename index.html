<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Baghdad: The Centre of the World</title>
    <style>
        :root { --gold: #d4af37; --bg: #12110f; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'serif'; }
        
        #boot {
            position: fixed; inset: 0; background: var(--bg); z-index: 1000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: var(--gold); text-align: center;
        }

        button {
            background: none; border: 2px solid var(--gold); color: var(--gold);
            padding: 20px 60px; font-size: 1.5rem; cursor: pointer;
            letter-spacing: 5px; margin-top: 30px; transition: 0.3s;
        }

        button:hover { background: var(--gold); color: #000; }

        #hud {
            position: absolute; bottom: 40px; left: 40px; width: 350px;
            color: #f4e4bc; background: rgba(0,0,0,0.85); padding: 25px;
            border-left: 3px solid var(--gold); opacity: 0; transition: 0.5s; pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="boot">
        <h1 style="letter-spacing:20px; font-size:3.5rem; margin:0;">BAGHDAD</h1>
        <p style="color:#6d5f4f; letter-spacing:5px;">RECONSTRUCTING 762 AD</p>
        <button id="start-btn" onclick="launch()">INITIALISE</button>
    </div>

    <div id="hud">
        <h2 id="b-name" style="margin:0; color:var(--gold);"></h2>
        <p id="b-lore" style="font-style:italic; font-size:0.95rem; margin-top:15px; line-height:1.6;"></p>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.module.min.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        let scene, camera, renderer, clock;
        let city, people, bData = [], pData = [];
        let isStarted = false;

        // --- AUTHENTIC ANCIENT STRING SYNTH ---
        function playAncientMusic() {
            const actx = new (window.AudioContext || window.webkitAudioContext)();
            const master = actx.createGain();
            master.gain.value = 0.5;
            master.connect(actx.destination);

            // D-Phrygian Dominant Scale (D, Eb, F#, G, A, Bb, C)
            const frequencies = [146.83, 155.56, 185.00, 220.00]; 
            
            frequencies.forEach((f, i) => {
                const osc = actx.createOscillator();
                const g = actx.createGain();
                // Sawtooth for the "buzz" of ancient strings
                osc.type = i === 0 ? 'sawtooth' : 'triangle';
                osc.frequency.value = f;
                
                // Add a slight "wobble" to mimic an old instrument
                const lfo = actx.createOscillator();
                const lfoGain = actx.createGain();
                lfo.frequency.value = 0.5 + Math.random();
                lfoGain.gain.value = 2;
                lfo.connect(lfoGain);
                lfoGain.connect(osc.frequency);
                lfo.start();

                g.gain.value = 0.1;
                osc.connect(g);
                g.connect(master);
                osc.start();
            });
        }

        window.launch = () => {
            if(isStarted) return;
            isStarted = true;
            playAncientMusic();
            document.getElementById('boot').style.opacity = '0';
            setTimeout(() => document.getElementById('boot').remove(), 1000);
            init();
            animate();
        };

        function init() {
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xd9c8a9); // BRIGHT DAYLIGHT
            scene.fog = new THREE.FogExp2(0xd9c8a9, 0.001);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 5000);
            camera.position.set(400, 300, 400);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.3;
            document.body.appendChild(renderer.domElement);

            // LIGHTING (PERMANENT NOON)
            const sun = new THREE.DirectionalLight(0xfffdf2, 2.0);
            sun.position.set(100, 500, 50);
            scene.add(sun);
            scene.add(new THREE.AmbientLight(0xfff4e0, 0.8));

            // THE TIGRIS RIVER
            const river = new THREE.Mesh(
                new THREE.PlaneGeometry(4000, 200),
                new THREE.MeshStandardMaterial({ color: 0x1a2a30, roughness: 0.2 })
            );
            river.rotation.x = -Math.PI / 2;
            river.position.y = -1;
            scene.add(river);

            // HOUSE OF WISDOM (CENTRE)
            const howBase = new THREE.Mesh(new THREE.CylinderGeometry(40, 45, 40, 8), new THREE.MeshStandardMaterial({color: 0x9c8263}));
            const howDome = new THREE.Mesh(new THREE.SphereGeometry(38, 32, 16, 0, 6.3, 0, 1.6), new THREE.MeshStandardMaterial({color: 0x1a4538}));
            howDome.position.y = 20;
            const how = new THREE.Group();
            how.add(howBase, howDome);
            how.userData = { name: "The House of Wisdom", lore: "The centre of scientific enquiry and translation in the Abbasid world." };
            scene.add(how);

            // DENSE CITY
            const count = 4000;
            const bGeo = new THREE.BoxGeometry(1, 1, 1);
            const bMat = new THREE.MeshStandardMaterial({color: 0x8b7355});
            city = new THREE.InstancedMesh(bGeo, bMat, count);
            scene.add(city);

            const grid = new Set();
            let idx = 0;
            for (let i = 0; i < 10000 && idx < count; i++) {
                const r = 130 + Math.random() * 600;
                const a = Math.random() * Math.PI * 2;
                const x = Math.round(Math.cos(a) * r / 20) * 20;
                const z = Math.round(Math.sin(a) * r / 20) * 20;

                if (grid.has(`${x},${z}`) || Math.abs(z) < 110) continue;
                grid.add(`${x},${z}`);

                const h = 10 + Math.random() * 25;
                bData.push({ x, z, h, y: 1000 + Math.random() * 500, ty: h/2 });
                idx++;
            }

            // HUMAN FIGURES (PROPORTIONAL)
            const pCount = 1000;
            const pGeo = new THREE.CapsuleGeometry(0.2, 1.2, 4, 8); // Human scale
            const pMat = new THREE.MeshStandardMaterial({color: 0x3d2b1f});
            people = new THREE.InstancedMesh(pGeo, pMat, pCount);
            scene.add(people);

            for (let i = 0; i < pCount; i++) {
                pData.push({ 
                    r: 140 + Math.random() * 550, 
                    a: Math.random() * Math.PI * 2, 
                    s: 0.005 + Math.random() * 0.01 
                });
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            const t = clock.getElapsedTime();
            const dummy = new THREE.Object3D();

            // Buildings Falling in
            bData.forEach((b, i) => {
                if (b.y > b.ty) b.y -= (b.y - b.ty) * 0.06;
                dummy.position.set(b.x, b.y, b.z);
                dummy.scale.set(16, b.h, 16);
                dummy.updateMatrix();
                city.setMatrixAt(i, dummy.matrix);
            });
            city.instanceMatrix.needsUpdate = true;

            // People Walking
            pData.forEach((p, i) => {
                p.a += p.s * 0.1;
                const bob = Math.abs(Math.sin(t * 8 + i)) * 0.2;
                dummy.position.set(Math.cos(p.a) * p.r, 0.7 + bob, Math.sin(p.a) * p.r);
                dummy.rotation.z = Math.sin(t * 8 + i) * 0.1;
                dummy.updateMatrix();
                people.setMatrixAt(i, dummy.matrix);
            });
            people.instanceMatrix.needsUpdate = true;

            renderer.render(scene, camera);
        }

        // Click to Inspect
        window.addEventListener('click', (e) => {
            if(!isStarted) return;
            const mouse = new THREE.Vector2((e.clientX / window.innerWidth) * 2 - 1, -(e.clientY / window.innerHeight) * 2 + 1);
            const ray = new THREE.Raycaster();
            ray.setFromCamera(mouse, camera);
            const hits = ray.intersectObjects(scene.children, true);
            if (hits.length > 0) {
                const hud = document.getElementById('hud');
                hud.style.opacity = 1;
                const d = hits[0].object.parent?.userData?.name ? hits[0].object.parent.userData : { name: "Domestic Dwelling", lore: "A residential structure built with thick clay walls to keep the interior cool." };
                document.getElementById('b-name').innerText = d.name;
                document.getElementById('b-lore').innerText = d.lore;
            }
        });
    </script>
</body>
</html>
