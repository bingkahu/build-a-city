<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baghdad: The Great Round City</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #d4af37; --sand: #f4e4bc; --bg: #0b0a09; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Cinzel', serif; }
        
        /* Full Multi-Slide Intro */
        #boot-sequence { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: var(--bg); z-index: 100; transition: opacity 1.5s; color: white; text-align: center; padding: 20px; }
        .intro-slide { opacity: 0; position: absolute; transition: opacity 0.5s; max-width: 800px; display: none; flex-direction: column; align-items: center; top: 20%; }
        .intro-slide.active { opacity: 1; display: flex; }
        .intro-slide h1 { color: var(--gold); letter-spacing: 15px; font-size: 3.5rem; margin: 0; }
        .intro-slide p { color: #a89078; font-size: 1.2rem; margin: 25px 0; line-height: 1.8; max-width: 650px; }
        
        .continue-btn, #start-btn { 
            padding: 14px 35px; background: none; border: 1px solid var(--gold); color: var(--gold); 
            cursor: pointer; font-family: 'Cinzel'; margin-top: 20px; transition: 0.3s; letter-spacing: 3px;
        }
        .continue-btn:hover, #start-btn:hover { background: var(--gold); color: black; box-shadow: 0 0 20px var(--gold); }
        .dev-credit { margin-top: 50px; font-size: 0.85rem; letter-spacing: 5px; color: var(--gold); opacity: 0.9; font-weight: bold; }

        /* UI Elements */
        #building-card {
            position: fixed; top: 25px; right: 25px; width: 320px;
            background: rgba(11, 10, 9, 0.95); border: 1px solid var(--gold);
            color: var(--sand); padding: 25px; display: none; z-index: 50; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #close-card { position: absolute; top: 10px; right: 15px; color: var(--gold); cursor: pointer; font-size: 1.8rem; }
        #map-scale-container { position: fixed; bottom: 25px; left: 25px; pointer-events: none; z-index: 20; }
        #scale-label { color: var(--gold); font-size: 0.75rem; font-weight: bold; }
        #scale-bracket { height: 8px; border: 2px solid var(--gold); border-top: none; width: 70px; }
    </style>
</head>
<body>

    <div id="building-card">
        <div id="close-card">Ã—</div>
        <h2 id="card-title" style="color: var(--gold); margin:0; font-size: 1.2rem;">Structure</h2>
        <hr style="border: 0.5px solid #444; margin: 15px 0;">
        <p id="card-desc" style="font-size: 0.9rem; color: #ccc; line-height: 1.5;"></p>
    </div>

    <div id="boot-sequence">
        <div class="intro-slide active">
            <h1>BAGHDAD</h1>
            <p>The year is 762 CE. Under the decree of Caliph Al-Mansur, the most perfect city in history is born on the banks of the Tigris.</p>
            <button class="continue-btn" onclick="nextSlide()">CONTINUE</button>
        </div>
        <div class="intro-slide">
            <h1>MADINAT AL-SALAM</h1>
            <p>The "City of Peace." A masterpiece of circular geometry, designed by the greatest astronomers and mathematicians of the age.</p>
            <button class="continue-btn" onclick="nextSlide()">CONTINUE</button>
        </div>
        <div class="intro-slide">
            <h1>GOLDEN AGE</h1>
            <p>From the House of Wisdom to the four mighty gates, explore the center of the world's knowledge and trade.</p>
            <button class="continue-btn" onclick="nextSlide()">CONTINUE</button>
        </div>
        <div class="intro-slide">
            <h1>BEGIN</h1>
            <p>Have fun! And begin.</p>
            <button id="start-btn" onclick="startApp()">START CHRONICLE</button>
            <div class="dev-credit">LEAD ARCHITECT: MATTEO</div>
        </div>
    </div>

    <div id="map-scale-container">
        <div id="scale-label">1:100</div>
        <div id="scale-bracket"></div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.module.min.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';

        let scene, camera, renderer, controls, cityBody, raycaster, mouse;
        const landmarks = [];
        const exclusionZones = []; 

        window.nextSlide = function() {
            const current = document.querySelector('.intro-slide.active');
            const next = current.nextElementSibling;
            if (next && next.classList.contains('intro-slide')) {
                current.classList.remove('active');
                next.classList.add('active');
            }
        };

        window.startApp = function() {
            document.getElementById('boot-sequence').style.opacity = '0';
            setTimeout(() => { document.getElementById('boot-sequence').remove(); init(); }, 1000);
        };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 30000);
            camera.position.set(2000, 1400, 2000);

            renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            const sun = new THREE.DirectionalLight(0xffffff, 1.8);
            sun.position.set(1000, 1500, 1000);
            scene.add(sun, new THREE.AmbientLight(0xffffff, 0.7));

            createWorld();
            window.addEventListener('click', onClick);
            document.getElementById('close-card').onclick = () => { document.getElementById('building-card').style.display = 'none'; };
            animate();
        }

        function createWorld() {
            const cityMat = new THREE.MeshStandardMaterial({ color: 0x8b7355 });
            const domeMat = new THREE.MeshStandardMaterial({ color: 0x2d5a27 });

            // Ground
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(15000, 15000), new THREE.MeshStandardMaterial({ color: 0xbfa37a }));
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // Tigris River
            const riverGeom = new THREE.RingGeometry(2000, 2400, 128, 1, 0, Math.PI * 1.2);
            const riverMat = new THREE.MeshStandardMaterial({ color: 0x1a4a8a, side: THREE.DoubleSide });
            const river = new THREE.Mesh(riverGeom, riverMat);
            river.rotation.x = -Math.PI / 2;
            river.position.y = 0.5;
            scene.add(river);
            exclusionZones.push({ x: 0, z: 0, rMin: 1950, rMax: 2450, isRiver: true });

            // 4 Gates
            const gateData = [
                {x:0, z:-1100, name: "Syrian Gate (Bab al-Sham)", desc: "Guarding the northwest, this gate connected Baghdad to the silk roads of the Levant."},
                {x:0, z:1100, name: "Kufa Gate (Bab al-Kufa)", desc: "The southern gateway leading toward the holy city of Kufa and the Arabian Peninsula."},
                {x:-1100, z:0, name: "Basra Gate (Bab al-Basra)", desc: "The primary entry for trade goods flowing up from the Persian Gulf via the port of Basra."},
                {x:1100, z:0, name: "Khurasan Gate (Bab al-Khurasan)", desc: "Facing the Tigris, this gate served as the main entry for travelers from Persia and the East."}
            ];
            gateData.forEach(data => {
                const gate = new THREE.Mesh(new THREE.BoxGeometry(200, 150, 200), cityMat);
                gate.position.set(data.x, 75, data.z);
                gate.userData = { title: data.name, desc: data.desc };
                scene.add(gate);
                landmarks.push(gate);
                exclusionZones.push({ x: data.x, z: data.z, r: 250 });
            });

            // House of Wisdom
            const howBase = new THREE.Mesh(new THREE.BoxGeometry(320, 130, 320), cityMat);
            const howDome = new THREE.Mesh(new THREE.SphereGeometry(110, 32, 16, 0, Math.PI*2, 0, Math.PI/2), domeMat);
            howDome.position.y = 65;
            const howGroup = new THREE.Group();
            howGroup.add(howBase, howDome);
            howGroup.userData = { title: "House of Wisdom (Bayt al-Hikma)", desc: "The intellectual heart of the Golden Age, where the world's knowledge was translated, preserved, and expanded." };
            scene.add(howGroup);
            landmarks.push(howBase); // Click detection on base
            exclusionZones.push({ x: 0, z: 0, r: 450 });

            // Mosques
            for (let i = 0; i < 5; i++) {
                const a = (i / 5) * Math.PI * 2, r = 700 + Math.random() * 300;
                const x = Math.cos(a)*r, z = Math.sin(a)*r;
                const mBase = new THREE.Mesh(new THREE.BoxGeometry(100, 60, 100), cityMat);
                const mDome = new THREE.Mesh(new THREE.SphereGeometry(45, 32, 16, 0, Math.PI*2, 0, Math.PI/2), domeMat);
                mDome.position.y = 30;
                const minaret = new THREE.Mesh(new THREE.CylinderGeometry(10, 10, 140), cityMat);
                minaret.position.set(45, 70, 45);
                const mGroup = new THREE.Group();
                mGroup.add(mBase, mDome, minaret);
                mGroup.position.set(x, 0, z);
                mGroup.userData = { title: "Grand Mosque", desc: "A place of worship and community, reflecting the architectural beauty of the Abbasid Caliphate." };
                scene.add(mGroup);
                landmarks.push(mBase); 
                exclusionZones.push({ x, z, r: 200 });
            }

            // Residential Buildings
            cityBody = new THREE.InstancedMesh(new THREE.BoxGeometry(1, 1, 1), cityMat, 4000);
            const dummy = new THREE.Object3D();
            let count = 0;
            for (let i = 0; i < 15000 && count < 4000; i++) {
                const distR = 320 + Math.random() * 1100, ang = Math.random() * Math.PI * 2;
                const x = Math.cos(ang) * distR, z = Math.sin(ang) * distR;
                let safe = true;
                for (let zne of exclusionZones) {
                    if (zne.isRiver) {
                        const rC = Math.sqrt(x*x + z*z);
                        if (rC > zne.rMin && rC < zne.rMax) safe = false;
                    } else if (Math.sqrt((x-zne.x)**2 + (z-zne.z)**2) < zne.r) safe = false;
                }
                if (safe) {
                    const h = 20 + Math.random() * 50, w = 15 + Math.random() * 20;
                    dummy.position.set(x, h/2, z); dummy.scale.set(w, h, w); dummy.updateMatrix();
                    cityBody.setMatrixAt(count, dummy.matrix);
                    const shd = 0.7 + Math.random() * 0.3;
                    cityBody.setColorAt(count, new THREE.Color(shd, shd * 0.92, shd * 0.85));
                    count++;
                }
            }
            scene.add(cityBody);
        }

        function onClick(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            const landmarkIntersects = raycaster.intersectObjects(landmarks);
            if (landmarkIntersects.length > 0) {
                const data = landmarkIntersects[0].object.userData.title ? landmarkIntersects[0].object.userData : landmarkIntersects[0].object.parent.userData;
                showCard(data.title, data.desc);
                return;
            }

            const cityIntersects = raycaster.intersectObject(cityBody);
            if (cityIntersects.length > 0) {
                showCard("Residential District", "A cluster of Abbasid dwellings housing the merchants and citizens of the Round City.");
            }
        }

        function showCard(title, desc) {
            document.getElementById('card-title').innerText = title.toUpperCase();
            document.getElementById('card-desc').innerText = desc.toUpperCase();
            document.getElementById('building-card').style.display = 'block';
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            const d = camera.position.distanceTo(controls.target);
            document.getElementById('scale-label').innerText = `1:${Math.round(d / 2.5)}`;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
