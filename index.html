<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baghdad: The Great Round City</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #d4af37; --sand: #f4e4bc; }
        body { margin: 0; overflow: hidden; background: #0b0a09; font-family: 'Cinzel', serif; }
        
        #boot-sequence { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #0b0a09; z-index: 100; transition: opacity 1.5s; color: white; text-align: center; padding: 20px; }
        .intro-slide { opacity: 0; position: absolute; transition: opacity 0.5s; max-width: 800px; display: none; flex-direction: column; align-items: center; top: 25%; }
        .intro-slide.active { opacity: 1; display: flex; }
        .intro-slide h1 { color: var(--gold); letter-spacing: 15px; font-size: 3rem; margin: 0; }
        .intro-slide p { color: #a89078; font-size: 1.2rem; margin: 20px 0; line-height: 1.6; }
        
        .continue-btn { 
            padding: 10px 25px; background: none; border: 1px solid var(--gold); color: var(--gold); 
            cursor: pointer; font-family: 'Cinzel'; margin-top: 20px; transition: 0.3s;
        }
        .continue-btn:hover { background: var(--gold); color: black; }

        #start-btn { 
            padding: 15px 40px; background: none; border: 2px solid var(--gold); color: var(--gold); 
            cursor: pointer; transition: 0.3s; font-family: 'Cinzel'; letter-spacing: 3px;
        }
        #start-btn:hover { background: var(--gold); color: #000; box-shadow: 0 0 20px var(--gold); }

        #building-card {
            position: fixed; top: 20px; right: 20px; width: 320px;
            background: rgba(11, 10, 9, 0.95); border: 1px solid var(--gold);
            color: var(--sand); padding: 25px; display: none; z-index: 50;
            backdrop-filter: blur(15px); transition: opacity 0.5s;
        }
        #close-card { position: absolute; top: 10px; right: 15px; color: var(--gold); cursor: pointer; font-size: 1.8rem; }
        #building-card h2 { color: var(--gold); margin: 0 0 10px 0; font-size: 1.1rem; border-bottom: 1px solid rgba(212,175,55,0.3); }
        #building-card p { font-size: 0.95rem; line-height: 1.6; color: #ccc; }
        
        #ui-layer { position: fixed; bottom: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; pointer-events: none; z-index: 10; }
        .ui-btn { pointer-events: all; text-decoration: none; font-size: 0.75rem; padding: 10px 18px; border: 1px solid var(--gold); color: var(--gold); background: rgba(0,0,0,0.7); }
    </style>
</head>
<body>

    <div id="building-card">
        <div id="close-card">×</div>
        <h2 id="card-title">Structure Found</h2>
        <p id="card-desc">Investigating records...</p>
    </div>

    <div id="boot-sequence">
        <div class="intro-slide active">
            <h1>BAGHDAD</h1>
            <p>Founded in 762 CE by Caliph Al-Mansur, this city became the "City of Peace." Its unique circular design was built to represent the center of the world.</p>
            <button class="continue-btn" onclick="nextSlide()">CONTINUE</button>
        </div>
        <div class="intro-slide">
            <h1>GOLDEN AGE</h1>
            <p>During the Abbasid Caliphate, Baghdad was the global hub for science, medicine, and trade. Scholars traveled thousands of miles to study here.</p>
            <button class="continue-btn" onclick="nextSlide()">CONTINUE</button>
        </div>
        <div class="intro-slide">
            <h1>HOUSE OF WISDOM</h1>
            <p>At the center of the city stood the Grand Library. It housed the world's knowledge, where ancient Greek and Indian texts were translated into Arabic.</p>
            <button class="continue-btn" onclick="nextSlide()">CONTINUE</button>
        </div>
        <div class="intro-slide">
            <h1>HAVE FUN!</h1>
            <p>Explore the Round City. Click on any building to see who lives there or what secrets it holds. Look for the Golden Dome in the center.</p>
            <button id="start-btn" onclick="startApp()">BEGIN CHRONICLE</button>
        </div>
    </div>

    <div id="ui-layer">
        <a href="#" class="ui-btn">LEAD ARCHITECT: [YOUR NAME]</a>
        <a href="https://github.com/bingkahu/build-a-city" target="_blank" class="ui-btn">⭐ SOURCE CODE</a>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.module.min.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';

        let scene, camera, renderer, controls, clock, cityBody, palaceGroup, raycaster, mouse;
        let isCinematic = true;

        const narratives = [
            "A bustling merchant house where silk and spices from China are weighed and sold.",
            "The home of a master astronomer who uses brass astrolabes to map the stars at night.",
            "A small workshop filled with mulberry-paper scrolls ready for the Grand Library.",
            "The residence of a royal scribe who translates ancient philosophy into Arabic.",
            "A crowded apothecary shop smelling of dried herbs, saffron, and mountain snow.",
            "A secure stone vault used by the Caliph's tax collectors to store gold dinars.",
            "The villa of a veteran guard who protects the city's famous Golden Gate.",
            "A quiet courtyard school where students practice calligraphy on wooden tablets."
        ];

        window.nextSlide = function() {
            const current = document.querySelector('.intro-slide.active');
            const next = current.nextElementSibling;
            if (next && next.classList.contains('intro-slide')) {
                current.classList.remove('active');
                next.classList.add('active');
            }
        };

        window.startApp = function() {
            document.getElementById('boot-sequence').style.opacity = '0';
            setTimeout(() => { document.getElementById('boot-sequence').remove(); init(); }, 1500);
        };

        function init() {
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 2000, 8000);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 15000);
            camera.position.set(2500, 1500, 2500);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.enabled = false;

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            const sun = new THREE.DirectionalLight(0xffffff, 2);
            sun.position.set(500, 1000, 500);
            scene.add(sun, new THREE.AmbientLight(0xffffff, 0.7));

            createCity();
            window.addEventListener('click', onClick);
            document.getElementById('close-card').onclick = () => { document.getElementById('building-card').style.display = 'none'; };
            animate();
        }

        function createCity() {
            // Ground
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(10000, 10000), new THREE.MeshStandardMaterial({ color: 0xbfa37a }));
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // RIVER FIX: Increased thickness and height to 1.5 to prevent all clipping
            const riverGeom = new THREE.CylinderGeometry(1350, 1350, 2, 64);
            const riverMat = new THREE.MeshStandardMaterial({ color: 0x1a4a8a, metalness: 0.6, roughness: 0.2 });
            const river = new THREE.Mesh(riverGeom, riverMat);
            river.position.y = 1; // Sits clearly above the sand
            scene.add(river);

            // Buildings
            const count = 3500;
            cityBody = new THREE.InstancedMesh(new THREE.BoxGeometry(1, 1, 1), new THREE.MeshStandardMaterial({ color: 0x8b7355 }), count);
            const dummy = new THREE.Object3D();
            for (let i = 0; i < count; i++) {
                const r = 250 + Math.random() * 800;
                const a = Math.random() * Math.PI * 2;
                const h = 20 + Math.random() * 40;
                const w = 15 + Math.random() * 10;
                dummy.position.set(Math.cos(a) * r, h/2, Math.sin(a) * r);
                dummy.scale.set(w, h, w);
                dummy.updateMatrix();
                cityBody.setMatrixAt(i, dummy.matrix);
            }
            scene.add(cityBody);

            // HOUSE OF WISDOM (Palace)
            palaceGroup = new THREE.Group();
            const pBase = new THREE.Mesh(new THREE.CylinderGeometry(100, 110, 80, 32), new THREE.MeshStandardMaterial({color: 0x9c8263}));
            const pDome = new THREE.Mesh(new THREE.SphereGeometry(90, 32, 16, 0, 6.3, 0, 1.6), new THREE.MeshStandardMaterial({color: 0xd4af37, metalness: 0.8, roughness: 0.2}));
            pDome.position.y = 40;
            palaceGroup.add(pBase, pDome);
            palaceGroup.name = "HouseOfWisdom"; // Named for the clicker
            scene.add(palaceGroup);
        }

        function onClick(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            // Check Palace first
            const palaceHit = raycaster.intersectObject(palaceGroup, true);
            if (palaceHit.length > 0) {
                showCard("The House of Wisdom", "The scientific and intellectual heart of the city. It contains thousands of manuscripts and scholars from every corner of the known world.");
                return;
            }

            // Check Buildings
            const hits = raycaster.intersectObject(cityBody);
            if (hits.length > 0) {
                const id = hits[0].instanceId;
                showCard("City Structure " + (id + 100), narratives[id % narratives.length]);
            }
        }

        function showCard(title, text) {
            const card = document.getElementById('building-card');
            document.getElementById('card-title').innerText = title;
            document.getElementById('card-desc').innerText = text;
            card.style.display = 'block';
            card.style.opacity = '1';
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();
            if (isCinematic) {
                camera.position.x = Math.cos(time * 0.15) * 2800;
                camera.position.z = Math.sin(time * 0.15) * 2800;
                camera.lookAt(0, 0, 0);
                if (time > 12) { isCinematic = false; controls.enabled = true; }
            }
            controls.update();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
