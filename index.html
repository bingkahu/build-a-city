<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baghdad: The Great Round City</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #d4af37; --sand: #f4e4bc; }
        body { margin: 0; overflow: hidden; background: #0b0a09; font-family: 'Cinzel', serif; }
        
        #boot-sequence { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #0b0a09; z-index: 100; transition: opacity 1.5s; color: white; text-align: center; padding: 20px; }
        .intro-slide { opacity: 0; position: absolute; transition: opacity 0.5s; max-width: 800px; display: none; flex-direction: column; align-items: center; top: 25%; }
        .intro-slide.active { opacity: 1; display: flex; }
        .intro-slide h1 { color: var(--gold); letter-spacing: 15px; font-size: 3rem; margin: 0; }
        .intro-slide p { color: #a89078; font-size: 1.2rem; margin: 20px 0; line-height: 1.6; }
        
        .continue-btn { 
            padding: 10px 25px; background: none; border: 1px solid var(--gold); color: var(--gold); 
            cursor: pointer; font-family: 'Cinzel'; margin-top: 20px; transition: 0.3s;
        }
        .continue-btn:hover { background: var(--gold); color: black; }

        #start-btn { 
            padding: 15px 40px; background: none; border: 2px solid var(--gold); color: var(--gold); 
            cursor: pointer; transition: 0.3s; font-family: 'Cinzel'; letter-spacing: 3px;
        }
        #start-btn:hover { background: var(--gold); color: #000; box-shadow: 0 0 20px var(--gold); }

        #building-card {
            position: fixed; top: 20px; right: 20px; width: 320px;
            background: rgba(11, 10, 9, 0.95); border: 1px solid var(--gold);
            color: var(--sand); padding: 25px; display: none; z-index: 50;
            backdrop-filter: blur(15px); transition: opacity 0.5s;
        }
        #close-card { position: absolute; top: 10px; right: 15px; color: var(--gold); cursor: pointer; font-size: 1.8rem; }
        #building-card h2 { color: var(--gold); margin: 0 0 10px 0; font-size: 1.1rem; border-bottom: 1px solid rgba(212,175,55,0.3); }
        #building-card p { font-size: 0.95rem; line-height: 1.6; color: #ccc; }
        
        #ui-layer { position: fixed; bottom: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; pointer-events: none; z-index: 10; }
        .ui-btn { pointer-events: all; text-decoration: none; font-size: 0.75rem; padding: 10px 18px; background: rgba(0,0,0,0.7); border: 1px solid var(--gold); color: var(--gold); }
    </style>
</head>
<body>

    <div id="building-card">
        <div id="close-card">×</div>
        <h2 id="card-title">Structure Found</h2>
        <p id="card-desc">Investigating records...</p>
    </div>

    <div id="boot-sequence">
        <div class="intro-slide active" id="slide-0">
            <h1>BAGHDAD</h1>
            <p>Founded in 762 CE by Caliph Al-Mansur. (Enter to Continue)</p>
            <button class="continue-btn" onclick="nextSlide()">CONTINUE</button>
        </div>
        <div class="intro-slide" id="slide-1">
            <h1>GOLDEN AGE</h1>
            <p>The global hub for science, medicine, and trade. Scholars traveled thousands of miles to study here.</p>
            <button class="continue-btn" onclick="nextSlide()">CONTINUE</button>
        </div>
        <div class="intro-slide" id="slide-2">
            <h1>HOUSE OF WISDOM</h1>
            <p>At the center stood the Grand Library. It housed the world's knowledge and ancient texts translated into Arabic.</p>
            <button class="continue-btn" onclick="nextSlide()">CONTINUE</button>
        </div>
        <div class="intro-slide" id="slide-3">
            <h1>HAVE FUN!</h1>
            <p>LEAD ARCHITECT: <span style="color:var(--gold)">MATTEO</span></p>
            <button id="start-btn" onclick="startApp()">BEGIN CHRONICLE</button>
        </div>
    </div>

    <div id="ui-layer">
        <a href="https://ko-fi.com/matteo44642" target="_blank" class="ui-btn">☕ SUPPORT ON KO-FI</a>
        <a href="https://github.com/bingkahu/build-a-city" target="_blank" class="ui-btn">⭐ STAR ON GITHUB</a>
    </div>

    <audio id="bg-music" loop>
        <source src="https://cdn.pixabay.com/audio/2022/08/02/audio_88440bc21d.mp3" type="audio/mpeg">
    </audio>

    <script type="importmap">
        { "imports": { "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.module.min.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';

        let scene, camera, renderer, controls, cityBody, detailsBody, palaceGroup, raycaster, mouse;

        // --- RESTORED DATA ---
        const prefixes = ["The Ancestral Home of", "The Workshop of", "The Estate of", "The Hidden Laboratory of", "The Residence of", "The Scholarly Retreat of", "The Private Library of", "The Fragrant Shop of", "The Secure Vault of", "The School of", "The Villa of", "The Foundry of"];
        const owners = ["a Silk Road Navigator", "an Abbasid Tax Collector", "a Master Astrolabe Maker", "a Royal Scribe", "a Paper Manufacturer", "a Greek Translator", "a Spice Merchant", "a Court Musician", "a Perfume Distiller", "a Wisdom Seeker", "a Veteran Guard", "a Calligrapher"];
        const narratives = ["This building features high mud-brick walls and a deep wind-tower for natural cooling.", "The courtyard contains a rare mechanical fountain powered by hidden hydraulics.", "The roof is used for astrolabe celestial observations at midnight.", "Vats of indigo dye dominate the ground floor, scenting the entire street.", "Inside, mulberry-paper scrolls are being cataloged for the House of Wisdom.", "A secret underground cellar stores snow brought from the mountains.", "The walls are decorated with intricate geometric girih patterns.", "Casks of imported ink from China wait by the door.", "The balcony offers a view of the Golden Gate for state processions.", "Small clay pipes run through the walls for water distribution.", "Dried herbs hang from the rafters for the nearby Bimaristan.", "A heavy cedar door protects the valuable leather-bound books inside."];

        window.addEventListener('keydown', (e) => {
            if (e.key === "Enter") {
                const current = document.querySelector('.intro-slide.active');
                if (current && current.id === "slide-3") {
                    startApp();
                } else {
                    nextSlide();
                }
            }
        });

        window.nextSlide = function() {
            const current = document.querySelector('.intro-slide.active');
            const next = current?.nextElementSibling;
            if (next && next.classList.contains('intro-slide')) {
                current.classList.remove('active');
                next.classList.add('active');
            }
        };

        window.startApp = function() {
            const music = document.getElementById('bg-music');
            music.play().catch(() => {});
            document.getElementById('boot-sequence').style.opacity = '0';
            setTimeout(() => { 
                document.getElementById('boot-sequence').remove(); 
                init(); 
                controls.enabled = true; 
            }, 1000);
        };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 20000);
            camera.position.set(2500, 1500, 2500);

            renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            const sun = new THREE.DirectionalLight(0xffffff, 2);
            sun.position.set(500, 1000, 500);
            scene.add(sun, new THREE.AmbientLight(0xffffff, 0.7));

            createCity();
            window.addEventListener('click', onClick);
            document.getElementById('close-card').onclick = () => { document.getElementById('building-card').style.display = 'none'; };
            animate();
        }

        function createCity() {
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(12000, 12000), new THREE.MeshStandardMaterial({ color: 0xbfa37a }));
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = -0.5; 
            scene.add(floor);

            // FLAT RIVER (Corrected: Flat but visible, no Z-fighting)
            const riverGeom = new THREE.CylinderGeometry(1400, 1400, 0.2, 64);
            const riverMat = new THREE.MeshStandardMaterial({ color: 0x1a4a8a, metalness: 0.1, roughness: 0.5 });
            const river = new THREE.Mesh(riverGeom, riverMat);
            river.position.y = 0.05; 
            scene.add(river);

            const cityMat = new THREE.MeshStandardMaterial({ color: 0x8b7355 });
            cityBody = new THREE.InstancedMesh(new THREE.BoxGeometry(1, 1, 1), cityMat, 4000);
            detailsBody = new THREE.InstancedMesh(new THREE.BoxGeometry(1.1, 0.1, 1.1), cityMat, 4000);
            const dummy = new THREE.Object3D();
            for (let i = 0; i < 4000; i++) {
                const r = 250 + Math.random() * 800;
                const a = Math.random() * Math.PI * 2;
                const h = 20 + Math.random() * 50;
                const w = 15 + Math.random() * 15;
                dummy.position.set(Math.cos(a) * r, h/2, Math.sin(a) * r);
                dummy.scale.set(w, h, w);
                dummy.updateMatrix();
                cityBody.setMatrixAt(i, dummy.matrix);
                dummy.position.y = h;
                dummy.scale.set(w * 1.1, 2, w * 1.1);
                dummy.updateMatrix();
                detailsBody.setMatrixAt(i, dummy.matrix);
            }
            scene.add(cityBody, detailsBody);

            palaceGroup = new THREE.Group();
            const pBase = new THREE.Mesh(new THREE.BoxGeometry(180, 80, 180), new THREE.MeshStandardMaterial({color: 0x9c8263}));
            const pDome = new THREE.Mesh(new THREE.SphereGeometry(70, 32, 16, 0, 6.3, 0, 1.6), new THREE.MeshStandardMaterial({color: 0x2d5a27})); 
            pDome.position.y = 40;
            palaceGroup.add(pBase, pDome);
            scene.add(palaceGroup);
        }

        function onClick(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            if (raycaster.intersectObject(palaceGroup, true).length > 0) {
                showCard("The House of Wisdom", "The scientific and intellectual heart of the city. It contains thousands of manuscripts and scholars from every corner of the known world.");
                return;
            }

            const hits = raycaster.intersectObject(cityBody);
            if (hits.length > 0) {
                const id = hits[0].instanceId;
                const title = prefixes[id % prefixes.length] + " " + owners[(id+7) % owners.length];
                showCard(title, narratives[id % narratives.length]);
            }
        }

        function showCard(title, text) {
            const card = document.getElementById('building-card');
            document.getElementById('card-title').innerText = title;
            document.getElementById('card-desc').innerText = text;
            card.style.display = 'block';
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
