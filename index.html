<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Default Statcounter code for Build A City -->
  <script type="text/javascript">
  var sc_project=13198625; 
  var sc_invisible=1; 
  var sc_security="add2d3ce"; 
  </script>
  <script type="text/javascript"
  src="https://www.statcounter.com/counter/counter.js" async></script>
  <noscript><div class="statcounter"><a title="Web Analytics"
  href="https://statcounter.com/" target="_blank"><img class="statcounter"
  src="https://c.statcounter.com/13198625/0/add2d3ce/1/" alt="Web Analytics"
  referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
  <!-- End of Statcounter Code -->

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Baghdad: The Great Round City</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root { --gold: #d4af37; --sand: #f4e4bc; }
    body { margin: 0; overflow: hidden; background: #0b0a09; font-family: 'Cinzel', serif; }

    #boot-sequence { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #0b0a09; z-index: 100; transition: opacity 1.5s; color: white; text-align: center; padding: 20px; }
    .intro-slide { opacity: 0; position: absolute; transition: opacity 0.5s; max-width: 800px; display: none; flex-direction: column; align-items: center; top: 25%; }
    .intro-slide.active { opacity: 1; display: flex; }
    .intro-slide h1 { color: var(--gold); letter-spacing: 15px; font-size: 3rem; margin: 0; }
    .intro-slide p { color: #a89078; font-size: 1.2rem; margin: 20px 0; line-height: 1.6; }

    .continue-btn { padding: 10px 25px; background: none; border: 1px solid var(--gold); color: var(--gold); cursor: pointer; font-family: 'Cinzel'; margin-top: 20px; transition: 0.3s; }
    .continue-btn:hover { background: var(--gold); color: black; }
    #start-btn { padding: 15px 40px; background: none; border: 2px solid var(--gold); color: var(--gold); cursor: pointer; transition: 0.3s; font-family: 'Cinzel'; letter-spacing: 3px; }
    #start-btn:hover { background: var(--gold); color: #000; box-shadow: 0 0 20px var(--gold); }

    #building-card { position: fixed; top: 20px; right: 20px; width: 320px; background: rgba(11, 10, 9, 0.95); border: 1px solid var(--gold); color: var(--sand); padding: 25px; display: none; z-index: 50; backdrop-filter: blur(15px); transition: opacity 0.5s; }
    #close-card { position: absolute; top: 10px; right: 15px; color: var(--gold); cursor: pointer; font-size: 1.8rem; }
    #building-card h2 { color: var(--gold); margin: 0 0 10px 0; font-size: 1.1rem; border-bottom: 1px solid rgba(212,175,55,0.3); }
    #building-card p { font-size: 0.95rem; line-height: 1.6; color: #ccc; }

    #map-scale-container { position: fixed; bottom: 20px; left: 20px; display: flex; flex-direction: column; align-items: flex-start; pointer-events: none; z-index: 20; }
    #scale-label { color: var(--gold); font-size: 0.75rem; margin-bottom: 4px; font-weight: bold; }
    #scale-bracket { height: 8px; border: 2px solid var(--gold); border-top: none; width: 60px; }

    #ui-layer { position: fixed; bottom: 20px; right: 20px; display: flex; gap: 10px; pointer-events: none; z-index: 10; }
    .ui-btn { pointer-events: all; text-decoration: none; font-size: 0.75rem; padding: 10px 18px; background: rgba(0,0,0,0.7); border: 1px solid var(--gold); color: var(--gold); }
  </style>
</head>
<body>

  <div id="building-card">
    <div id="close-card">Ã—</div>
    <h2 id="card-title">Structure Found</h2>
    <p id="card-desc">Investigating records...</p>
  </div>

  <div id="boot-sequence">
    <div class="intro-slide active" id="slide-0">
      <h1>BAGHDAD</h1>
      <p>The Round City of Peace, 8th Century CE.</p>
      <button class="continue-btn" onclick="nextSlide()">CONTINUE</button>
    </div>
    <div class="intro-slide" id="slide-3">
      <h1>EXPLORE</h1>
      <p>Lead Architect: <span style="color:var(--gold)">MATTEO</span></p>
      <button id="start-btn" onclick="startApp()">BEGIN CHRONICLE</button>
    </div>
  </div>

  <div id="map-scale-container">
    <div id="scale-label">1:100</div>
    <div id="scale-bracket"></div>
  </div>

  <div id="ui-layer"><a href="#" class="ui-btn">VIEW MAP</a></div>

  <audio id="bg-music" loop>
    <source src="https://cdn.pixabay.com/audio/2022/08/02/audio_88440bc21d.mp3" type="audio/mpeg">
  </audio>
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.module.min.js",
      "three/examples/jsm/controls/OrbitControls.js": "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js",
      "three/examples/jsm/postprocessing/EffectComposer.js": "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/EffectComposer.js",
      "three/examples/jsm/postprocessing/RenderPass.js": "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/RenderPass.js",
      "three/examples/jsm/postprocessing/UnrealBloomPass.js": "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/UnrealBloomPass.js",
      "three/examples/jsm/postprocessing/SSAOPass.js": "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/SSAOPass.js",
      "three/examples/jsm/postprocessing/FilmPass.js": "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/FilmPass.js",
      "three/examples/jsm/postprocessing/ShaderPass.js": "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/ShaderPass.js",
      "three/examples/jsm/shaders/FXAAShader.js": "https://unpkg.com/three@0.160.0/examples/jsm/shaders/FXAAShader.js",
      "three/examples/jsm/shaders/VignetteShader.js": "https://unpkg.com/three@0.160.0/examples/jsm/shaders/VignetteShader.js"
    }
  }
  </script>

  <script type="module">
  import * as THREE from 'three';
  import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
  import { EffectComposer } from 'three/examples/jsm/postprocessing/EffectComposer.js';
  import { RenderPass } from 'three/examples/jsm/postprocessing/RenderPass.js';
  import { UnrealBloomPass } from 'three/examples/jsm/postprocessing/UnrealBloomPass.js';
  import { SSAOPass } from 'three/examples/jsm/postprocessing/SSAOPass.js';
  import { FilmPass } from 'three/examples/jsm/postprocessing/FilmPass.js';
  import { ShaderPass } from 'three/examples/jsm/postprocessing/ShaderPass.js';
  import { FXAAShader } from 'three/examples/jsm/shaders/FXAAShader.js';
  import { VignetteShader } from 'three/examples/jsm/shaders/VignetteShader.js';
  class GraphicsEngine {
    constructor({ renderer, scene, camera }) {
      this.renderer = renderer;
      this.scene = scene;
      this.camera = camera;

      // Resize handling
      this.size = new THREE.Vector2(window.innerWidth, window.innerHeight);
      window.addEventListener('resize', () => this.onResize());

      // Composer
      this.composer = new EffectComposer(this.renderer);
      this.renderPass = new RenderPass(this.scene, this.camera);
      this.composer.addPass(this.renderPass);

      // FXAA (edge smoothing)
      this.fxaaPass = new ShaderPass(FXAAShader);
      this.fxaaPass.material.uniforms['resolution'].value.set(1 / this.size.x, 1 / this.size.y);
      this.composer.addPass(this.fxaaPass);

      // SSAO (ambient occlusion)
      this.ssaoPass = new SSAOPass(this.scene, this.camera, this.size.x, this.size.y);
      this.ssaoPass.kernelRadius = 16;
      this.ssaoPass.minDistance = 0.005;
      this.ssaoPass.maxDistance = 0.1;
      this.composer.addPass(this.ssaoPass);

      // Bloom (cinematic glow)
      const bloomStrength = 0.8, bloomRadius = 0.2, bloomThreshold = 0.6;
      this.bloomPass = new UnrealBloomPass(new THREE.Vector2(this.size.x, this.size.y), bloomStrength, bloomRadius, bloomThreshold);
      this.composer.addPass(this.bloomPass);

      // Vignette (subtle focus)
      this.vignettePass = new ShaderPass(VignetteShader);
      this.vignettePass.uniforms['offset'].value = 1.0;
      this.vignettePass.uniforms['darkness'].value = 1.2;
      this.composer.addPass(this.vignettePass);

      // Film grain (texture)
      this.filmPass = new FilmPass(0.35, 0.025, 648, false);
      this.composer.addPass(this.filmPass);

      // Scene fog for depth
      this.scene.fog = new THREE.FogExp2(0x8fbcd4, 0.00008);

      // Night city lights (emissive points)
      this.cityLights = new THREE.Group();
      this.scene.add(this.cityLights);

      // Heat shimmer particles (subtle)
      const particleGeo = new THREE.BufferGeometry();
      const particleCount = 800;
      const positions = new Float32Array(particleCount * 3);
      for (let i = 0; i < particleCount; i++) {
        positions[i*3] = (Math.random() - 0.5) * 3000;
        positions[i*3+1] = 50 + Math.random() * 150;
        positions[i*3+2] = (Math.random() - 0.5) * 3000;
      }
      particleGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
      const particleMat = new THREE.PointsMaterial({ color: 0xffddaa, size: 6, sizeAttenuation: true, transparent: true, opacity: 0.15 });
      this.particles = new THREE.Points(particleGeo, particleMat);
      this.scene.add(this.particles);
    }

    addCityLight(x, y, z) {
      const bulb = new THREE.Mesh(
        new THREE.SphereGeometry(2, 8, 8),
        new THREE.MeshBasicMaterial({ color: 0xffd27a })
      );
      bulb.position.set(x, y, z);
      this.cityLights.add(bulb);
    }

    onResize() {
      this.size.set(window.innerWidth, window.innerHeight);
      this.renderer.setSize(this.size.x, this.size.y);
      this.composer.setSize(this.size.x, this.size.y);
      this.fxaaPass.material.uniforms['resolution'].value.set(1 / this.size.x, 1 / this.size.y);
      this.bloomPass.setSize(this.size.x, this.size.y);
    }

    render(dt) {
      // Animate particles gently
      const pos = this.particles.geometry.attributes.position;
      for (let i = 0; i < pos.count; i++) {
        const y = pos.getY(i);
        pos.setY(i, y + Math.sin((i + performance.now() * 0.0005)) * 0.05);
      }
      pos.needsUpdate = true;

      // Render pipeline
      this.composer.render();
    }
  }
  let scene, camera, renderer, controls, cityBody, palaceGroup, raycaster, mouse, gfx, clock;
  const mosques = [];
  const gates = [];
  const prefixes = ["The Ancestral Home of", "The Workshop of", "The Estate of", "The Hidden Laboratory of"];
  const owners = ["a Silk Road Navigator", "an Abbasid Tax Collector", "a Master Astrolabe Maker", "a Royal Scribe"];
  const narratives = ["Features high mud-brick walls and a deep wind-tower.", "The courtyard contains a rare mechanical fountain.", "The roof is used for celestial observations."];
  const mosqueNames = ["The Great Mosque of Al-Mansur", "Friday Mosque", "The Turquoise Sanctuary", "The Al-Khulafa Mosque", "Oratory of the Scholars"];
  const mosqueLore = ["The muezzin's call echoes from the minaret.", "A center for theological debate.", "Paved with cool marble.", "The dome is clad in green glazed tiles.", "Scholars rest here after study."];

  window.nextSlide = function() {
    const current = document.querySelector('.intro-slide.active');
    const next = current?.nextElementSibling;
    if (next && next.classList.contains('intro-slide')) {
      current.classList.remove('active');
      next.classList.add('active');
    }
  };

  window.startApp = function() {
    document.getElementById('bg-music').play().catch(() => {});
    document.getElementById('boot-sequence').style.opacity = '0';
    setTimeout(() => { document.getElementById('boot-sequence').remove(); init(); }, 1000);
  };

  function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB);
    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 30000);
    camera.position.set(2200, 1500, 2200);
    renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    raycaster = new THREE.Raycaster();
    mouse = new THREE.Vector2();

    const sun = new THREE.DirectionalLight(0xffffff, 2);
    sun.position.set(500, 1000, 500);
    scene.add(sun, new THREE.AmbientLight(0xffffff, 0.7));

    createCity();

    window.addEventListener('click', onClick);
    document.getElementById('close-card').onclick = () => { document.getElementById('building-card').style.display = 'none'; };

    clock = new THREE.Clock();
    gfx = new GraphicsEngine({ renderer, scene, camera });
    animate();
  }

  function createCity() {
    const floor = new THREE.Mesh(new THREE.PlaneGeometry(12000, 12000), new THREE.MeshStandardMaterial({ color: 0xbfa37a }));
    floor.rotation.x = -Math.PI / 2;
    scene.add(floor);

    const cityMat = new THREE.MeshStandardMaterial({ color: 0x8b7355 });
    const wallMat = new THREE.MeshStandardMaterial({ color: 0x6b5335 });

    // Circular Walls
    const createWall = (radius, height, width) => {
      const wall = new THREE.Mesh(new THREE.TorusGeometry(radius, width, 16, 100), wallMat);
      wall.rotation.x = Math.PI / 2;
      wall.position.y = height / 2;
      scene.add(wall);
    };
    createWall(1500, 60, 20); 
    createWall(600, 80, 15);

    // Mosques
    const mosquePositions = [];
    for (let i = 0; i < 5; i++) {
      const r = 750 + Math.random() * 400;
      const a = (i / 5) * Math.PI * 2;
      const x = Math.cos(a) * r;
      const z = Math.sin(a) * r;
      const mosqueGroup = new THREE.Group();
      const mBase = new THREE.Mesh(new THREE.BoxGeometry(45, 35, 45), cityMat);
      const mDome = new THREE.Mesh(new THREE.SphereGeometry(20, 16, 8, 0, 6.3, 0, 1.6), new THREE.MeshStandardMaterial({color: 0x2d5a27}));
      mDome.position.y = 17;
      const minaret = new THREE.Mesh(new THREE.CylinderGeometry(6, 6, 70), cityMat);
      minaret.position.set(18, 25, 18);
      mosqueGroup.add(mBase, mDome, minaret);
      mosqueGroup.position.set(x, 0, z);
      mosqueGroup.userData = { title: mosqueNames[i], desc: mosqueLore[i] };
      scene.add(mosqueGroup);
      mosques.push(mosqueGroup);
      mosquePositions.push({x, z, radius: 90});
    }

    // Gates
    const gateNames = ["Kufa Gate", "Basra Gate", "Khurasan Gate", "Syrian Gate"];
    const gateAngles = [Math.PI / 2, 0, Math.PI, -Math.PI / 2];
    gateAngles.forEach((angle, i) => {
      const x = Math.cos(angle) * 1500;
      const z = Math.sin(angle) * 1500;
      const gateMesh = new THREE.Mesh(new THREE.BoxGeometry(80, 120, 80), wallMat);
      gateMesh.position.set(x, 60, z);
      gateMesh.userData = { title: gateNames[i], desc: "One of the four grand entrances to the Round City." };
      scene.add(gateMesh);
      gates.push(gateMesh);
      // Add a light near each gate for night ambiance
      gfx?.addCityLight(x, 20, z);
    });

    // Residential Districts
    cityBody = new THREE.InstancedMesh(new THREE.BoxGeometry(1, 1, 1), cityMat, 4000);
    const dummy = new THREE.Object3D();
    let count = 0;
    for (let i = 0; i < 4000; i++) {
      const r = 680 + Math.random() * 750;
      const a = Math.random() * Math.PI * 2;
      if (Math.abs(a % (Math.PI / 2)) < 0.15) continue; // Gate roads
      const x = Math.cos(a) * r;
      const z = Math.sin(a) * r;
      let overlap = mosquePositions.some(p => Math.sqrt((x-p.x)**2 + (z-p.z)**2) < p.radius);
      if (!overlap && count < 4000) {
        const h = 20 + Math.random() * 40;
        const w = 15 + Math.random() * 15;
        dummy.position.set(x, h/2, z);
        dummy.rotation.y = -a;
        dummy.scale.set(w, h, w);
        dummy.updateMatrix();
        cityBody.setMatrixAt(count, dummy.matrix);
        const s = 0.7 + Math.random() * 0.3;
        cityBody.setColorAt(count, new THREE.Color(s, s * 0.9, s * 0.8));
        count++;
        // occasional city light
        if (Math.random() < 0.02) gfx?.addCityLight(x, 8, z);
      }
    }
    scene.add(cityBody);

    // Palace
    palaceGroup = new THREE.Group();
    const pBase = new THREE.Mesh(new THREE.CylinderGeometry(120, 120, 90, 32), new THREE.MeshStandardMaterial({color: 0x9c8263}));
    const pDome = new THREE.Mesh(new THREE.SphereGeometry(80, 32, 16, 0, 6.3, 0, 1.6), new THREE.MeshStandardMaterial({color: 0x2d5a27})); 
    pDome.position.y = 45;
    palaceGroup.add(pBase, pDome);
    scene.add(palaceGroup);
  }
  function updateScale() {
    const ratio = Math.round(camera.position.distanceTo(controls.target) / 2);
    document.getElementById('scale-label').innerText = `1:${ratio}`;
  }

  function onClick(event) {
    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);

    const check = (arr) => {
      for (let obj of arr) {
        if (raycaster.intersectObject(obj, true).length > 0) {
          showCard(obj.userData.title, obj.userData.desc);
          return true;
        }
      }
      return false;
    };

    if (raycaster.intersectObject(palaceGroup, true).length > 0) {
      return showCard("The House of Wisdom", "The scientific heart of the city.");
    }
    if (check(mosques) || check(gates)) return;

    const hits = raycaster.intersectObject(cityBody);
    if (hits.length > 0) {
      const id = hits[0].instanceId;
      showCard(prefixes[id % 4] + " " + owners[id % 4], narratives[id % 3]);
    }
  }

  function showCard(title, text) {
    document.getElementById('card-title').innerText = title;
    document.getElementById('card-desc').innerText = text;
    document.getElementById('building-card').style.display = 'block';
  }

  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    updateScale();
    const dt = clock.getDelta();
    gfx.render(dt);
  }
 </script>
 </body>
 </html>
