<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baghdad: The Great Round City</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #d4af37; --sand: #f4e4bc; }
        body { margin: 0; overflow: hidden; background: #0b0a09; font-family: 'Cinzel', serif; }
        
        /* [Existing Intro Styles Unchanged] */
        #boot-sequence { position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #0b0a09; z-index: 100; transition: opacity 1.5s; color: white; text-align: center; padding: 20px; }
        .intro-slide { opacity: 0; position: absolute; transition: opacity 1.5s; max-width: 800px; }
        .intro-slide.active { opacity: 1; }
        .intro-slide h1 { color: var(--gold); letter-spacing: 15px; }
        button { padding: 15px 40px; background: none; border: 2px solid var(--gold); color: var(--gold); cursor: pointer; opacity: 0; pointer-events: none; transition: 0.3s; }
        button.active { opacity: 1; pointer-events: all; }

        /* NEW UI FOR DESCRIPTIONS */
        #building-card {
            position: fixed; top: 20px; right: 20px; width: 300px;
            background: rgba(11, 10, 9, 0.9); border: 1px solid var(--gold);
            color: var(--sand); padding: 20px; display: none; z-index: 50;
            backdrop-filter: blur(10px); pointer-events: all;
        }
        #building-card h2 { color: var(--gold); margin: 0 0 10px 0; font-size: 1.2rem; }
        #building-card p { font-size: 0.9rem; line-height: 1.4; margin: 0; }

        #ui-layer { position: fixed; bottom: 20px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; pointer-events: none; z-index: 10; }
        .ui-btn { pointer-events: all; text-decoration: none; font-size: 0.8rem; padding: 8px 15px; background: rgba(0,0,0,0.6); border: 1px solid var(--gold); color: var(--gold); }
    </style>
</head>
<body>

    <div id="building-card">
        <h2 id="card-title">Structure</h2>
        <p id="card-desc">Click a building to investigate.</p>
    </div>

    <div id="boot-sequence">
        <div class="intro-slide active" id="slide1"><h1>BAGHDAD</h1><p>The "City of Peace", founded in 762 CE.</p></div>
        <div class="intro-slide" id="slide2"><h1>GOLDEN AGE</h1><p>The heart of science and culture.</p></div>
        <div class="intro-slide" id="slide3"><h1>SIMULATION</h1><p>A digital homage to history.</p></div>
        <div class="intro-slide" id="slide4"><h1>HAVE FUN!</h1><p>Explore the radiant city.</p></div>
        <button id="start-btn">BEGIN CHRONICLE</button>
    </div>

    <div id="ui-layer">
        <a href="https://ko-fi.com/matteo44642" target="_blank" class="ui-btn">Support on Ko-fi</a>
        <a href="https://github.com/bingkahu/build-a-city" target="_blank" class="ui-btn">‚≠ê STAR ON GITHUB</a>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.module.min.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';

        let scene, camera, renderer, controls, clock, river, cityBody, raycaster, mouse;

        // DATA POOLS FOR UNIQUE DESCRIPTIONS
        const prefixes = ["The House of", "The Quarters of", "The Workshop of", "The Estate of", "The Residence of"];
        const names = ["a Silk Merchant", "a Court Astrologer", "a Calligrapher", "a Paper Maker", "a Translator", "an Abbasid Official", "a Mathmatician"];
        const details = [
            "This structure features high mud-brick walls designed to keep the interior cool during the desert noon.",
            "Inside, scholars are currently translating ancient Greek texts into Arabic.",
            "The rooftop is used for drying dyed fabrics and star-gazing at night.",
            "A small courtyard hidden within contains a fountain and a single pomegranate tree.",
            "The cellar is filled with scrolls from the House of Wisdom.",
            "Incense smoke wafts from the narrow windows, carrying scents from the Silk Road."
        ];

        // INTRO LOGIC
        const slides = document.querySelectorAll('.intro-slide');
        const startBtn = document.getElementById('start-btn');
        let currentSlide = 0;

        window.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && currentSlide < slides.length - 1) {
                slides[currentSlide].classList.remove('active');
                currentSlide++;
                slides[currentSlide].classList.add('active');
                if(currentSlide === 3) startBtn.classList.add('active');
            }
        });

        startBtn.onclick = () => {
            const audio = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3');
            audio.loop = true; audio.play();
            document.getElementById('boot-sequence').style.opacity = '0';
            setTimeout(() => { document.getElementById('boot-sequence').remove(); init(); }, 1500);
        };

        function init() {
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 3500, 9500);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 20000);
            camera.position.set(3800, 2800, 3800);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            const sun = new THREE.DirectionalLight(0xffffff, 2.2);
            sun.position.set(1500, 3500, 1000);
            scene.add(sun, new THREE.AmbientLight(0xffffff, 0.7));

            createWorld();
            window.addEventListener('click', onDocumentMouseDown);
            animate();
        }

        function createWorld() {
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(20000, 20000), new THREE.MeshStandardMaterial({ color: 0xd2b48c }));
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            const riverGeo = new THREE.RingGeometry(2100, 2500, 64);
            river = new THREE.Mesh(riverGeo, new THREE.MeshStandardMaterial({ color: 0x0077be, metalness: 0.8, transparent: true, opacity: 0.8 }));
            river.rotation.x = -Math.PI / 2;
            river.position.y = 5;
            scene.add(river);

            const count = 4500;
            cityBody = new THREE.InstancedMesh(new THREE.BoxGeometry(1, 1, 1), new THREE.MeshStandardMaterial({ color: 0xa89078 }), count);
            const dummy = new THREE.Object3D();
            for (let i = 0; i < count; i++) {
                const r = 350 + Math.random() * 1450;
                const a = Math.random() * Math.PI * 2;
                const h = 40 + Math.random() * 90;
                dummy.position.set(Math.cos(a) * r, h/2, Math.sin(a) * r);
                dummy.scale.set(35, h, 35);
                dummy.updateMatrix();
                cityBody.setMatrixAt(i, dummy.matrix);
            }
            scene.add(cityBody);
        }

        function onDocumentMouseDown(event) {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            const intersects = raycaster.intersectObject(cityBody);
            if (intersects.length > 0) {
                // Generate unique description using the ID of the clicked instance
                const id = intersects[0].instanceId;
                const title = prefixes[id % prefixes.length] + " " + names[id % names.length];
                const desc = details[id % details.length] + " Located in District " + (id % 12 + 1) + ".";
                
                document.getElementById('card-title').innerText = title;
                document.getElementById('card-desc').innerText = desc;
                document.getElementById('building-card').style.display = 'block';
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if(river) river.material.opacity = 0.7 + Math.sin(clock.getElapsedTime()) * 0.1;
            controls.update();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
